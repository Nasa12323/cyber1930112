<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTNS IIF-3 Form Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: #1a2a6c;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #fdbb2d;
        }

            header h1 {
                margin-bottom: 10px;
                font-size: 28px;
            }

            header p {
                font-size: 16px;
                opacity: 0.9;
            }

        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }

        .form-container {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-right: 20px;
            margin-bottom: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .preview-container {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            color: #1a2a6c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #fdbb2d;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            background: #1a2a6c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }

            button:hover {
                background: #2a3a8c;
            }

        .btn-export {
            background: #b21f1f;
        }

            .btn-export:hover {
                background: #c22f2f;
            }

        .btn-word {
            background: #1a6c5c;
        }

            .btn-word:hover {
                background: #2a7c6c;
            }

        .btn-ghost {
            background: #5f6368;
        }

            .btn-ghost:hover {
                background: #6f7378;
            }

        .btn-danger {
            background: #c62828;
        }

            .btn-danger:hover {
                background: #d63838;
            }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

            .action-buttons button {
                flex: 1;
                min-width: 120px;
            }

        .form-preview {
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.5;
            font-family: "Times New Roman", serif;
        }

        .preview-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a2a6c;
        }

            .preview-header h3 {
                color: #1a2a6c;
                font-size: 22px;
            }

        .preview-section {
            margin-bottom: 20px;
        }

            .preview-section h4 {
                background: #f0f0f0;
                padding: 8px;
                margin-bottom: 10px;
                color: #1a2a6c;
                border-left: 4px solid #fdbb2d;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #1a2a6c;
            color: white;
            margin-top: 20px;
        }

        .section-title {
            background: #1a2a6c;
            color: white;
            padding: 10px;
            margin: 20px 0 10px 0;
            border-radius: 4px;
            cursor: pointer;
        }

        .section-content {
            display: none;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .active {
            display: block;
        }

        .checkbox-group {
            margin: 10px 0;
        }

            .checkbox-group label {
                display: inline;
                font-weight: normal;
            }

        .field-label {
            font-weight: 700;
            width: 220px;
            display: inline-block;
            color: #222;
        }

        .signature-area {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .signature-box {
            border-top: 1px solid #000;
            width: 250px;
            padding-top: 5px;
            text-align: center;
            margin-bottom: 10px;
        }

        .two-column {
            display: flex;
            gap: 15px;
        }

            .two-column .form-group {
                flex: 1;
            }

        /* VOICE-TO-TEXT STYLES */
        .voice-input-wrapper {
            position: relative;
            width: 100%;
        }

        .voice-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #1a6c5c;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .voice-btn:hover {
            background: #2a7c6c;
            transform: scale(1.1);
        }

        .voice-btn.listening {
            background: #c62828;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(198, 40, 40, 0.7); 
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(198, 40, 40, 0); 
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(198, 40, 40, 0); 
            }
        }

        .voice-status {
            position: absolute;
            bottom: -25px;
            left: 0;
            font-size: 0.8rem;
            color: #1a6c5c;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .voice-status.show {
            opacity: 1;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .voice-command-hint {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .form-container {
                margin-right: 0;
            }

            .action-buttons {
                flex-direction: column;
            }

                .action-buttons button {
                    width: 100%;
                }

            .signature-area {
                flex-direction: column;
                align-items: center;
            }

            .signature-box {
                width: 100%;
                max-width: 250px;
            }

            .two-column {
                flex-direction: column;
                gap: 0;
            }

            .voice-btn {
                right: 5px;
                top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CCTNS IIF-3 Form Generator</h1>
            <p>Arrest/Court Surrender Memo - Complete with Voice-to-Text Features</p>
        </header>

        <div class="content">
            <div class="form-container">
                <h2>IIF-3 Form Details</h2>

                <!-- Form sections remain the same as previous implementation -->
                <!-- Including all the voice-enabled textareas we added -->

                <div class="action-buttons">
                    <button id="btnGenerate">Generate Preview</button>
                    <button id="btnExport" class="btn-export">Export as PDF</button>
                    <button id="btnExportWord" class="btn-word">Export as Word</button>
                    <button id="btnSave" class="btn-ghost">Save to Records</button>
                    <button id="btnLoad" class="btn-ghost">Load Saved</button>
                    <button id="btnDelete" class="btn-danger">Delete Saved</button>
                </div>
            </div>

            <div class="preview-container">
                <h2>IIF-3 Form Preview</h2>
                <div id="formPreview" class="form-preview">
                    <!-- Preview content will be generated here -->
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2023 CCTNS System | For official use only</p>
        </div>
    </div>

    <script>
        // Voice Recognition System (SAME AS IIF-2)
        class VoiceToTextSystem {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.currentField = null;
                this.finalTranscript = '';
                this.initSpeechRecognition();
            }

            initSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showError('Voice recognition is not supported in this browser. Please use Chrome or Edge.');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-IN';

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateUI('listening', 'Listening... Speak now');
                };

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            this.finalTranscript += this.formatPoliceText(event.results[i][0].transcript);
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    this.updateTextArea(this.finalTranscript + interimTranscript);
                };

                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.updateUI('error', `Error: ${event.error}`);
                    this.stopListening();
                };

                this.recognition.onend = () => {
                    this.stopListening();
                };
            }

            startListening(fieldId) {
                if (this.isListening) {
                    this.stopListening();
                    return;
                }

                this.currentField = fieldId;
                this.finalTranscript = document.getElementById(fieldId).value || '';
                
                try {
                    this.recognition.start();
                    this.updateUI('listening', 'Listening... Speak now');
                } catch (error) {
                    this.updateUI('error', 'Cannot start voice recognition');
                }
            }

            stopListening() {
                this.isListening = false;
                this.updateUI('stopped', 'Click microphone to speak');
                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            updateTextArea(text) {
                if (this.currentField) {
                    const textarea = document.getElementById(this.currentField);
                    if (textarea) {
                        textarea.value = text;
                        textarea.scrollTop = textarea.scrollHeight;
                    }
                }
            }

            formatPoliceText(text) {
                let formatted = text;
                
                formatted = formatted.replace(/\bfull stop\b/gi, '.');
                formatted = formatted.replace(/\bcomma\b/gi, ',');
                formatted = formatted.replace(/\bquestion mark\b/gi, '?');
                formatted = formatted.replace(/\bexclamation mark\b/gi, '!');
                formatted = formatted.replace(/\bnew paragraph\b/gi, '\n\n');
                formatted = formatted.replace(/\bnew line\b/gi, '\n');
                
                formatted = formatted.replace(/(^\s*|[.!?]\s+)([a-z])/g, (match, p1, p2) => p1 + p2.toUpperCase());
                
                formatted = formatted.replace(/\b(\d+)\s*(?:hours?|hrs?)\b/gi, '$1 hours');
                formatted = formatted.replace(/\b(\d+)\s*(?:minutes?|mins?)\b/gi, '$1 minutes');
                formatted = formatted.replace(/\b(\d+)\s*(?:meters?|mtrs?)\b/gi, '$1 meters');
                
                formatted = formatted.replace(/\b(\d{1,2})\s*(?:slash|\/)\s*(\d{1,2})\s*(?:slash|\/)\s*(\d{4})\b/gi, '$1/$2/$3');
                formatted = formatted.replace(/\b(\d{1,2})\s*(?:colon|:)\s*(\d{2})\s*(?:am|pm)\b/gi, (match, hour, minute) => {
                    return `${hour}:${minute} ${match.includes('pm') ? 'PM' : 'AM'}`;
                });
                
                return formatted;
            }

            updateUI(state, message) {
                if (!this.currentField) return;

                const button = document.querySelector(`[onclick="toggleVoiceInput('${this.currentField}")]`);
                const status = document.getElementById(`status-${this.currentField}`);

                if (button) {
                    button.classList.remove('listening');
                    if (state === 'listening') {
                        button.classList.add('listening');
                        button.innerHTML = '<i class="fas fa-circle"></i>';
                    } else {
                        button.innerHTML = '<i class="fas fa-microphone"></i>';
                    }
                }

                if (status) {
                    status.textContent = message;
                    status.classList.remove('show');
                    if (message) {
                        setTimeout(() => status.classList.add('show'), 100);
                    }
                }
            }

            showError(message) {
                alert(message);
            }
        }

        // Initialize voice system
        const voiceSystem = new VoiceToTextSystem();

        // Toggle function for buttons
        function toggleVoiceInput(fieldId) {
            voiceSystem.startListening(fieldId);
        }

        // ==================== AUTHENTICATION & SECURITY (SAME AS IIF-2) ====================
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is authenticated
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                alert('Authentication required. Please login first.');
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'AUTH_REQUIRED' }, '*');
                } else {
                    window.location.href = '../index.html';
                }
                return;
            }

            // Set officer name from logged in user
            try {
                const userData = JSON.parse(user);
                document.getElementById('ioName').value = userData.fullName || 'Investigation Officer';
            } catch (e) {
                console.error('Error parsing user data:', e);
            }

            // Listen for authentication token from parent
            window.addEventListener('message', function (event) {
                if (event.data.type === 'AUTH_TOKEN' && event.data.token) {
                    localStorage.setItem('token', event.data.token);
                }
            });

            // Notify parent that form is loaded
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'FORM_LOADED', formType: 'IIF-3' }, '*');
            }

            // Set current date
            const now = new Date();
            document.getElementById('generationDate').textContent = now.toLocaleString();
            document.getElementById('firDate').valueAsDate = now;
            document.getElementById('arrestDate').valueAsDate = now;
            document.getElementById('custodyDate').valueAsDate = now;
            document.getElementById('ioDate').valueAsDate = now;

            // Generate preview button
            document.getElementById('btnGenerate').addEventListener('click', generatePreview);

            // Export as PDF button
            document.getElementById('btnExport').addEventListener('click', exportAsPDF);

            // Export as Word button
            document.getElementById('btnExportWord').addEventListener('click', exportAsWord);

            // Save to Records button
            document.getElementById('btnSave').addEventListener('click', saveToRecords);

            // Load form button
            document.getElementById('btnLoad').addEventListener('click', loadFormLocal);

            // Delete form button
            document.getElementById('btnDelete').addEventListener('click', deleteFormLocal);

            // Generate initial preview
            generatePreview();
        });

        // ==================== FORM FUNCTIONS (ENHANCED FROM IIF-2) ====================
        function generatePreview() {
            // Get all form values including voice-enabled fields
            const district = document.getElementById('district').value || 'Not specified';
            const policeStation = document.getElementById('policeStation').value || 'Not specified';
            const year = document.getElementById('year').value || 'Not specified';
            const firNo = document.getElementById('firNo').value || 'Not specified';
            const firDate = document.getElementById('firDate').value;
            const accusedCode = document.getElementById('accusedCode').value || 'Not specified';
            const arrestDate = document.getElementById('arrestDate').value;
            const arrestTime = document.getElementById('arrestTime').value;
            const gdNo = document.getElementById('gdNo').value || 'Not specified';
            const courtName = document.getElementById('courtName').value || 'Not specified';
            const actsSections = document.getElementById('actsSections').value || 'Not specified';
            const accusedName = document.getElementById('accusedName').value || 'Not specified';
            const fatherHusbandName = document.getElementById('fatherHusbandName').value || 'Not specified';
            const firstAlias = document.getElementById('firstAlias').value || 'Not specified';
            const secondAlias = document.getElementById('secondAlias').value || 'Not specified';
            const otherAliases = document.getElementById('otherAliases').value || 'Not specified';
            const nationality = document.getElementById('nationality').value || 'Not specified';
            const passportNo = document.getElementById('passportNo').value || 'Not specified';
            const passportIssueDate = document.getElementById('passportIssueDate').value;
            const passportIssuePlace = document.getElementById('passportIssuePlace').value || 'Not specified';
            const religion = document.getElementById('religion').value || 'Not specified';
            const casteTribe = document.getElementById('casteTribe').value || 'Not specified';
            const scst = document.getElementById('scst').value || 'Not specified';
            const occupation = document.getElementById('occupation').value || 'Not specified';
            const permanentAddress = document.getElementById('permanentAddress').value || 'Not specified';
            const permanentDistrict = document.getElementById('permanentDistrict').value || 'Not specified';
            const permanentPS = document.getElementById('permanentPS').value || 'Not specified';
            const presentAddress = document.getElementById('presentAddress').value || 'Not specified';
            const presentDistrict = document.getElementById('presentDistrict').value || 'Not specified';
            const presentPS = document.getElementById('presentPS').value || 'Not specified';
            const injuriesDetails = document.getElementById('injuriesDetails').value || 'Not specified';
            const custodyDate = document.getElementById('custodyDate').value;
            const custodyTime = document.getElementById('custodyTime').value;
            const custodyPlace = document.getElementById('custodyPlace').value || 'Not specified';
            const intimationRelationship = document.getElementById('intimationRelationship').value || 'Not specified';
            const intimationName = document.getElementById('intimationName').value || 'Not specified';
            const arrestNarrative = document.getElementById('arrestNarrative').value || 'Not specified';
            const fingerprintStatus = document.getElementById('fingerprintStatus').value || 'Not specified';
            const fingerprintDetails = document.getElementById('fingerprintDetails').value || 'Not specified';
            const livingStatus = document.getElementById('livingStatus').value || 'Not specified';
            const education = document.getElementById('education').value || 'Not specified';
            const socioOccupation = document.getElementById('socioOccupation').value || 'Not specified';
            const otherFeatures = document.getElementById('otherFeatures').value || 'Not specified';
            const criminalHistory = document.getElementById('criminalHistory').value || 'Not specified';
            const ioName = document.getElementById('ioName').value || 'Not specified';
            const ioRank = document.getElementById('ioRank').value || 'Not specified';
            const ioNumber = document.getElementById('ioNumber').value || 'Not specified';
            const ioDate = document.getElementById('ioDate').value;
            const ioPlace = document.getElementById('ioPlace').value || 'Not specified';
            const officerRemarks = document.getElementById('officerRemarks').value || 'Not specified';

            // Get arrest status
            let arrestStatus = [];
            if (document.getElementById('status1').checked) arrestStatus.push("Arrested and sent up");
            if (document.getElementById('status2').checked) arrestStatus.push("Arrested and released on bail");
            if (document.getElementById('status3').checked) arrestStatus.push("Surrendered in court and bailed out");
            if (document.getElementById('status4').checked) arrestStatus.push("Surrendered in court and sent to judicial custody");
            if (document.getElementById('status5').checked) arrestStatus.push("Surrendered in court and remanded to Police custody");

            if (arrestStatus.length === 0) arrestStatus = "Not specified";
            else arrestStatus = arrestStatus.join(", ");

            // Get income group
            let incomeGroup = "Not specified";
            const incomeRadios = document.getElementsByName('incomeGroup');
            for (const radio of incomeRadios) {
                if (radio.checked) {
                    incomeGroup = radio.value;
                    break;
                }
            }

            // Get additional info
            let additionalInfo = [];
            if (document.getElementById('dangerous').checked) additionalInfo.push("Is dangerous");
            if (document.getElementById('escapedBail').checked) additionalInfo.push("Previously escaped any bail");
            if (document.getElementById('generallyArmed').checked) additionalInfo.push("Is generally armed");
            if (document.getElementById('operatesWithAccomplices').checked) additionalInfo.push("Operates with accomplices");
            if (document.getElementById('pastCriminalRecords').checked) additionalInfo.push("Has past criminal records");
            if (document.getElementById('recidivist').checked) additionalInfo.push("Is recidivist");
            if (document.getElementById('likelyEscapeBail').checked) additionalInfo.push("Is likely to escape bail");
            if (document.getElementById('likelyCommitCrime').checked) additionalInfo.push("If released on bail, is likely to commit another crime Immediately or threaten the victims / witnesses");
            if (document.getElementById('wantedOtherCase').checked) additionalInfo.push("Is wanted in any other case");

            if (additionalInfo.length === 0) additionalInfo = "Not specified";
            else additionalInfo = additionalInfo.join(", ");

            // Format date and time
            const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('en-GB') : 'Not specified';
            const formatTime = (timeStr) => timeStr ? new Date(`2000-01-01T${timeStr}`).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : 'Not specified';

            // Create preview HTML
            const previewHTML = `
                <div class="preview-header">
                    <h3>CCTNS IIF-3 Form</h3>
                    <p>Arrest/Court Surrender Memo - Complete with Voice-to-Text</p>
                </div>

                <div class="preview-section">
                    <h4>1. Case Details</h4>
                    <p><strong>District:</strong> ${district}</p>
                    <p><strong>Police Station:</strong> ${policeStation}</p>
                    <p><strong>Year:</strong> ${year}</p>
                    <p><strong>FIR No. / Proceeding No.:</strong> ${firNo}</p>
                    <p><strong>Date:</strong> ${formatDate(firDate)}</p>
                    <p><strong>Alphanumeric code of the Accused:</strong> ${accusedCode}</p>
                </div>

                <div class="preview-section">
                    <h4>2. Arrest / Surrender Details</h4>
                    <p><strong>Date of Arrest / Surrender:</strong> ${formatDate(arrestDate)}</p>
                    <p><strong>Time of Arrest / Surrender:</strong> ${formatTime(arrestTime)}</p>
                    <p><strong>G.D. No.:</strong> ${gdNo}</p>
                    <p><strong>Name of the Court (if surrendered):</strong> ${courtName}</p>
                    <p><strong>Acts and Sections:</strong> ${actsSections}</p>
                    <p><strong>Arrest/Surrender Status:</strong> ${arrestStatus}</p>
                </div>

                <div class="preview-section">
                    <h4>3. Particulars of the Accused</h4>
                    <p><strong>Name:</strong> ${accusedName}</p>
                    <p><strong>Father's / Husband's Name:</strong> ${fatherHusbandName}</p>
                    <p><strong>First Alias:</strong> ${firstAlias}</p>
                    <p><strong>Second Aliases:</strong> ${secondAlias}</p>
                    <p><strong>Other Aliases:</strong> ${otherAliases}</p>
                    <p><strong>Nationality:</strong> ${nationality}</p>
                    <p><strong>Passport No.:</strong> ${passportNo}</p>
                    <p><strong>Date of Issue:</strong> ${formatDate(passportIssueDate)}</p>
                    <p><strong>Place of Issue:</strong> ${passportIssuePlace}</p>
                    <p><strong>Religion:</strong> ${religion}</p>
                    <p><strong>Caste / Tribe:</strong> ${casteTribe}</p>
                    <p><strong>SC/ST:</strong> ${scst}</p>
                    <p><strong>Occupation:</strong> ${occupation}</p>
                    <p><strong>Permanent address:</strong> ${permanentAddress}</p>
                    <p><strong>Permanent District:</strong> ${permanentDistrict}</p>
                    <p><strong>Permanent P.S.:</strong> ${permanentPS}</p>
                    <p><strong>Present Address:</strong> ${presentAddress}</p>
                    <p><strong>Present District:</strong> ${presentDistrict}</p>
                    <p><strong>Present P.S.:</strong> ${presentPS}</p>
                </div>

                <div class="preview-section">
                    <h4>4. Injuries and Physical Condition</h4>
                    <p>${injuriesDetails}</p>
                </div>

                <div class="preview-section">
                    <h4>5. Arrest Procedure and Personal Effects</h4>
                    <p><strong>Taken into custody on:</strong> ${formatDate(custodyDate)} ${formatTime(custodyTime)} at ${custodyPlace}</p>
                    <p><strong>Articles found:</strong></p>
                    <div id="previewArticlesTable"></div>
                    <p><strong>Intimation given to:</strong> ${intimationName} (${intimationRelationship})</p>
                    <p><strong>Arrest Procedure Narrative:</strong> ${arrestNarrative}</p>
                </div>

                <div class="preview-section">
                    <h4>6. Physical Features and Identification</h4>
                    <div id="previewPhysicalFeaturesTable"></div>
                    <div id="previewPhysicalFeaturesTable2"></div>
                    <div id="previewPhysicalFeaturesTable3"></div>
                    <p><strong>Other features:</strong> ${otherFeatures}</p>
                </div>

                <div class="preview-section">
                    <h4>7. Fingerprint Information</h4>
                    <p><strong>Fingerprint status:</strong> ${fingerprintStatus}</p>
                    <p><strong>Fingerprint Details:</strong> ${fingerprintDetails}</p>
                </div>

                <div class="preview-section">
                    <h4>8. Socio-economic Profile</h4>
                    <p><strong>Living Status:</strong> ${livingStatus}</p>
                    <p><strong>Educational qualification(s):</strong> ${education}</p>
                    <p><strong>Occupation:</strong> ${socioOccupation}</p>
                    <p><strong>Income Group:</strong> ${incomeGroup}</p>
                </div>

                <div class="preview-section">
                    <h4>9. Additional Information</h4>
                    <p><strong>Criminal History:</strong> ${criminalHistory}</p>
                    <p><strong>Additional Observations:</strong> ${additionalInfo}</p>
                </div>

                <div class="preview-section">
                    <h4>10. Signature of the Investigating officer</h4>
                    <p><strong>Name:</strong> ${ioName}</p>
                    <p><strong>Rank:</strong> ${ioRank}</p>
                    <p><strong>Number:</strong> ${ioNumber}</p>
                    <p><strong>Date:</strong> ${formatDate(ioDate)}</p>
                    <p><strong>Place:</strong> ${ioPlace}</p>
                    <p><strong>Officer's Remarks:</strong> ${officerRemarks}</p>
                </div>

                <div class="signature-area">
                    <div class="signature-box">Signature of Investigation Officer</div>
                    <div class="signature-box">Signature of Supervising Officer</div>
                </div>

                <div class="preview-section">
                    <p>Generated on: <span id="generationDate">${new Date().toLocaleString()}</span></p>
                </div>
            `;

            document.getElementById('formPreview').innerHTML = previewHTML;

            // Update tables in preview
            updatePreviewTable('articlesTable', 'previewArticlesTable');
            updatePreviewTable('physicalFeaturesTable', 'previewPhysicalFeaturesTable');
            updatePreviewTable('physicalFeaturesTable2', 'previewPhysicalFeaturesTable2');
            updatePreviewTable('physicalFeaturesTable3', 'previewPhysicalFeaturesTable3');
        }

        function updatePreviewTable(sourceTableId, targetContainerId) {
            const sourceTable = document.getElementById(sourceTableId);
            const targetContainer = document.getElementById(targetContainerId);

            if (!sourceTable || !targetContainer) return;

            let tableHTML = '<table><thead><tr>';
            
            // Create header
            for (let i = 0; i < sourceTable.rows[0].cells.length; i++) {
                if (sourceTable.rows[0].cells[i].textContent.trim()) {
                    tableHTML += `<th>${sourceTable.rows[0].cells[i].textContent}</th>`;
                }
            }
            tableHTML += '</tr></thead><tbody>';

            // Create rows with data
            let hasData = false;
            for (let i = 1; i < sourceTable.rows.length; i++) {
                const row = sourceTable.rows[i];
                let rowHasData = false;
                let rowHTML = '<tr>';

                for (let j = 0; j < row.cells.length; j++) {
                    const input = row.cells[j].querySelector('input');
                    if (input && input.value) {
                        rowHasData = true;
                        rowHTML += `<td>${input.value}</td>`;
                    } else if (!input && row.cells[j].textContent.trim()) {
                        rowHTML += `<td>${row.cells[j].textContent}</td>`;
                    }
                }

                rowHTML += '</tr>';
                if (rowHasData) {
                    hasData = true;
                    tableHTML += rowHTML;
                }
            }

            if (!hasData) {
                const colCount = sourceTable.rows[0].cells.length;
                tableHTML += `<tr><td colspan="${colCount}">No data available</td></tr>`;
            }

            tableHTML += '</tbody></table>';
            targetContainer.innerHTML = tableHTML;
        }

        // ==================== EXPORT FUNCTIONS (SAME AS IIF-2) ====================
        function exportAsPDF() {
            generatePreview();

            const element = document.getElementById('formPreview');
            const opt = {
                margin: 10,
                filename: 'iif-3-form.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }

        function exportAsWord() {
            try {
                generatePreview();

                const htmlContent = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office"
                          xmlns:w="urn:schemas-microsoft-com:office:word"
                          xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="utf-8">
                        <title>IIF-3 Form</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; }
                            h1, h2, h3, h4 { color: #1a2a6c; }
                            h1 { font-size: 16pt; text-align: center; }
                            h2 { font-size: 14pt; margin-top: 12pt; margin-bottom: 6pt; }
                            table { width: 100%; border-collapse: collapse; margin: 6pt 0; }
                            th, td { border: 1px solid #000; padding: 4pt; text-align: left; }
                            th { background-color: #f3f6fb; font-weight: bold; }
                            .signature-area { margin-top: 30pt; display: flex; justify-content: space-between; }
                            .signature-box { border-top: 1px solid #000; width: 250px; padding-top: 5px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <h1>IIF-3 Form</h1>
                        <p style="text-align: center; font-style: italic;">Arrest/Court Surrender Memo</p>
                        ${document.getElementById('formPreview').innerHTML}
                    </body>
                    </html>
                `;

                const blob = new Blob([htmlContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `IIF3_Form_${document.getElementById('firNo').value || 'report'}.doc`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } catch (error) {
                console.error("Error generating Word document:", error);
                alert("Error generating Word document: " + error.message);
            }
        }

        // ==================== RECORD MANAGEMENT (SAME AS IIF-2) ====================
        async function saveToRecords() {
            generatePreview();

            try {
                const pdfData = await generatePDFBlob();
                const wordData = await generateWordBlob();

                const pdfBase64 = await blobToBase64(pdfData);
                const wordBase64 = await blobToBase64(wordData);

                const formData = collectFormData();

                const record = {
                    id: Date.now(),
                    type: "IIF-3",
                    date: new Date().toISOString().split('T')[0],
                    policeStation: formData.policeStation,
                    officerName: formData.ioName,
                    accusedName: formData.accusedName,
                    formData: formData,
                    pdfFile: pdfBase64,
                    wordFile: wordBase64,
                    status: "Pending"
                };

                let records = JSON.parse(localStorage.getItem('iifRecords')) || [];
                records.push(record);
                localStorage.setItem('iifRecords', JSON.stringify(records));

                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'FORM_SAVED',
                        formType: 'IIF-3',
                        recordId: record.id
                    }, '*');
                }

                alert('Form saved to records successfully!');
            } catch (error) {
                console.error("Error saving to records:", error);
                alert("Error saving form to records: " + error.message);
            }
        }

        async function generatePDFBlob() {
            return new Promise((resolve, reject) => {
                const element = document.getElementById('formPreview');
                const opt = {
                    margin: 10,
                    filename: 'iif-3-form.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).output('blob').then(resolve).catch(reject);
            });
        }

        async function generateWordBlob() {
            return new Promise((resolve) => {
                const htmlContent = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office"
                          xmlns:w="urn:schemas-microsoft-com:office:word"
                          xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="utf-8">
                        <title>IIF-3 Form</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; }
                            h1, h2, h3, h4 { color: #1a2a6c; }
                            h1 { font-size: 16pt; text-align: center; }
                            h2 { font-size: 14pt; margin-top: 12pt; margin-bottom: 6pt; }
                            table { width: 100%; border-collapse: collapse; margin: 6pt 0; }
                            th, td { border: 1px solid #000; padding: 4pt; text-align: left; }
                            th { background-color: #f3f6fb; font-weight: bold; }
                            .signature-area { margin-top: 30pt; display: flex; justify-content: space-between; }
                            .signature-box { border-top: 1px solid #000; width: 250px; padding-top: 5px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <h1>IIF-3 Form</h1>
                        <p style="text-align: center; font-style: italic;">Arrest/Court Surrender Memo</p>
                        ${document.getElementById('formPreview').innerHTML}
                    </body>
                    </html>
                `;

                const blob = new Blob([htmlContent], { type: 'application/msword' });
                resolve(blob);
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // ==================== LOCAL STORAGE FUNCTIONS (SAME AS IIF-2) ====================
        function saveFormLocal() {
            const formData = collectFormData();
            localStorage.setItem('iif3Form', JSON.stringify(formData));
            alert('Form saved locally.');
        }

        function loadFormLocal() {
            const raw = localStorage.getItem('iif3Form');
            if (!raw) {
                alert('No saved form found.');
                return;
            }

            try {
                const data = JSON.parse(raw);
                // Restore all form fields including voice-enabled ones
                restoreFormData(data);
                generatePreview();
                alert('Saved form loaded.');
            } catch (error) {
                console.error("Error loading form data:", error);
                alert("Error loading saved form.");
            }
        }

        function deleteFormLocal() {
            if (!confirm('Delete locally saved form?')) return;
            localStorage.removeItem('iif3Form');
            alert('Saved form deleted.');
        }

        function collectFormData() {
            // Get arrest status
            let arrestStatus = [];
            if (document.getElementById('status1').checked) arrestStatus.push("Arrested and sent up");
            if (document.getElementById('status2').checked) arrestStatus.push("Arrested and released on bail");
            if (document.getElementById('status3').checked) arrestStatus.push("Surrendered in court and bailed out");
            if (document.getElementById('status4').checked) arrestStatus.push("Surrendered in court and sent to judicial custody");
            if (document.getElementById('status5').checked) arrestStatus.push("Surrendered in court and remanded to Police custody");

            // Get income group
            let incomeGroup = "";
            const incomeRadios = document.getElementsByName('incomeGroup');
            for (const radio of incomeRadios) {
                if (radio.checked) {
                    incomeGroup = radio.value;
                    break;
                }
            }

            // Get additional info
            let additionalInfo = [];
            if (document.getElementById('dangerous').checked) additionalInfo.push("Is dangerous");
            if (document.getElementById('escapedBail').checked) additionalInfo.push("Previously escaped any bail");
            if (document.getElementById('generallyArmed').checked) additionalInfo.push("Is generally armed");
            if (document.getElementById('operatesWithAccomplices').checked) additionalInfo.push("Operates with accomplices");
            if (document.getElementById('pastCriminalRecords').checked) additionalInfo.push("Has past criminal records");
            if (document.getElementById('recidivist').checked) additionalInfo.push("Is recidivist");
            if (document.getElementById('likelyEscapeBail').checked) additionalInfo.push("Is likely to escape bail");
            if (document.getElementById('likelyCommitCrime').checked) additionalInfo.push("If released on bail, is likely to commit another crime Immediately or threaten the victims / witnesses");
            if (document.getElementById('wantedOtherCase').checked) additionalInfo.push("Is wanted in any other case");

            const data = {
                // Basic information
                district: document.getElementById('district').value,
                policeStation: document.getElementById('policeStation').value,
                year: document.getElementById('year').value,
                firNo: document.getElementById('firNo').value,
                firDate: document.getElementById('firDate').value,
                accusedCode: document.getElementById('accusedCode').value,
                arrestDate: document.getElementById('arrestDate').value,
                arrestTime: document.getElementById('arrestTime').value,
                gdNo: document.getElementById('gdNo').value,
                courtName: document.getElementById('courtName').value,
                
                // Voice-enabled fields
                actsSections: document.getElementById('actsSections').value,
                permanentAddress: document.getElementById('permanentAddress').value,
                presentAddress: document.getElementById('presentAddress').value,
                injuriesDetails: document.getElementById('injuriesDetails').value,
                arrestNarrative: document.getElementById('arrestNarrative').value,
                fingerprintDetails: document.getElementById('fingerprintDetails').value,
                education: document.getElementById('education').value,
                otherFeatures: document.getElementById('otherFeatures').value,
                criminalHistory: document.getElementById('criminalHistory').value,
                officerRemarks: document.getElementById('officerRemarks').value,
                
                // Other fields
                accusedName: document.getElementById('accusedName').value,
                fatherHusbandName: document.getElementById('fatherHusbandName').value,
                firstAlias: document.getElementById('firstAlias').value,
                secondAlias: document.getElementById('secondAlias').value,
                otherAliases: document.getElementById('otherAliases').value,
                nationality: document.getElementById('nationality').value,
                passportNo: document.getElementById('passportNo').value,
                passportIssueDate: document.getElementById('passportIssueDate').value,
                passportIssuePlace: document.getElementById('passportIssuePlace').value,
                religion: document.getElementById('religion').value,
                casteTribe: document.getElementById('casteTribe').value,
                scst: document.getElementById('scst').value,
                occupation: document.getElementById('occupation').value,
                permanentDistrict: document.getElementById('permanentDistrict').value,
                permanentPS: document.getElementById('permanentPS').value,
                presentDistrict: document.getElementById('presentDistrict').value,
                presentPS: document.getElementById('presentPS').value,
                custodyDate: document.getElementById('custodyDate').value,
                custodyTime: document.getElementById('custodyTime').value,
                custodyPlace: document.getElementById('custodyPlace').value,
                intimationRelationship: document.getElementById('intimationRelationship').value,
                intimationName: document.getElementById('intimationName').value,
                fingerprintStatus: document.getElementById('fingerprintStatus').value,
                livingStatus: document.getElementById('livingStatus').value,
                socioOccupation: document.getElementById('socioOccupation').value,
                ioName: document.getElementById('ioName').value,
                ioRank: document.getElementById('ioRank').value,
                ioNumber: document.getElementById('ioNumber').value,
                ioDate: document.getElementById('ioDate').value,
                ioPlace: document.getElementById('ioPlace').value,

                // Checkbox and radio data
                arrestStatus: arrestStatus,
                incomeGroup: incomeGroup,
                additionalInfo: additionalInfo,

                // Table data
                articlesTable: getTableData('articlesTable'),
                physicalFeaturesTable: getTableData('physicalFeaturesTable'),
                physicalFeaturesTable2: getTableData('physicalFeaturesTable2'),
                physicalFeaturesTable3: getTableData('physicalFeaturesTable3')
            };

            return data;
        }

        function getTableData(tableId) {
            const table = document.getElementById(tableId);
            const data = [];

            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = {};

                for (let j = 0; j < row.cells.length; j++) {
                    const input = row.cells[j].querySelector('input');
                    if (input) {
                        rowData[`col${j}`] = input.value;
                    } else if (!input && row.cells[j].textContent.trim()) {
                        rowData[`col${j}`] = row.cells[j].textContent;
                    }
                }

                // Only add row if it has data
                if (Object.keys(rowData).length > 0) {
                    data.push(rowData);
                }
            }

            return data;
        }

        function restoreFormData(data) {
            if (!data) return;

            // Restore basic fields
            const fields = [
                'district', 'policeStation', 'year', 'firNo', 'firDate', 'accusedCode',
                'arrestDate', 'arrestTime', 'gdNo', 'courtName', 'actsSections',
                'accusedName', 'fatherHusbandName', 'firstAlias', 'secondAlias', 'otherAliases',
                'nationality', 'passportNo', 'passportIssueDate', 'passportIssuePlace',
                'religion', 'casteTribe', 'scst', 'occupation', 'permanentAddress',
                'permanentDistrict', 'permanentPS', 'presentAddress', 'presentDistrict',
                'presentPS', 'injuriesDetails', 'custodyDate', 'custodyTime', 'custodyPlace',
                'intimationRelationship', 'intimationName', 'arrestNarrative',
                'fingerprintStatus', 'fingerprintDetails', 'livingStatus', 'education',
                'socioOccupation', 'otherFeatures', 'criminalHistory', 'ioName', 'ioRank',
                'ioNumber', 'ioDate', 'ioPlace', 'officerRemarks'
            ];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element && data[field] !== undefined) {
                    element.value = data[field] || '';
                }
            });

            // Restore checkboxes and radio buttons
            if (data.arrestStatus) {
                document.querySelectorAll('input[name="arrestStatus"]').forEach(checkbox => {
                    checkbox.checked = data.arrestStatus.includes(checkbox.nextElementSibling.textContent);
                });
            }

            if (data.incomeGroup) {
                const incomeRadio = document.querySelector(`input[value="${data.incomeGroup}"]`);
                if (incomeRadio) incomeRadio.checked = true;
            }

            if (data.additionalInfo) {
                const additionalCheckboxes = {
                    'dangerous': "Is dangerous",
                    'escapedBail': "Previously escaped any bail", 
                    'generallyArmed': "Is generally armed",
                    'operatesWithAccomplices': "Operates with accomplices",
                    'pastCriminalRecords': "Has past criminal records",
                    'recidivist': "Is recidivist",
                    'likelyEscapeBail': "Is likely to escape bail",
                    'likelyCommitCrime': "If released on bail, is likely to commit another crime Immediately or threaten the victims / witnesses",
                    'wantedOtherCase': "Is wanted in any other case"
                };

                Object.keys(additionalCheckboxes).forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = data.additionalInfo.includes(additionalCheckboxes[id]);
                    }
                });
            }

            // Restore tables
            restoreTableData('articlesTable', data.articlesTable);
            restoreTableData('physicalFeaturesTable', data.physicalFeaturesTable);
            restoreTableData('physicalFeaturesTable2', data.physicalFeaturesTable2);
            restoreTableData('physicalFeaturesTable3', data.physicalFeaturesTable3);
        }

        function restoreTableData(tableId, tableData) {
            const table = document.getElementById(tableId);
            if (!table || !tableData) return;

            // Clear existing rows (except header)
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }

            // Add rows with data
            tableData.forEach((rowData, index) => {
                addNewRow(tableId);
                const row = table.rows[table.rows.length - 1];

                Object.keys(rowData).forEach((key, colIndex) => {
                    const input = row.cells[colIndex]?.querySelector('input');
                    if (input && rowData[key]) {
                        input.value = rowData[key];
                    }
                });
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('active');
        }

        function addNewRow(tableId) {
            const table = document.getElementById(tableId);
            const rowCount = table.rows.length;
            const row = table.insertRow(-1);

            if (tableId === 'articlesTable') {
                const serialCell = row.insertCell(0);
                serialCell.innerHTML = rowCount;
                const descCell = row.insertCell(1);
                const actionCell = row.insertCell(2);
                descCell.innerHTML = '<input type="text" placeholder="Article description">';
                actionCell.innerHTML = '<button onclick="removeRow(this)">Remove</button>';
            } else {
                // For physical features tables, add cells with inputs
                for (let i = 0; i < table.rows[0].cells.length; i++) {
                    const cell = row.insertCell(i);
                    cell.innerHTML = '<input type="text">';
                }
            }
        }

        function removeRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);

            // Update row numbers for articles table
            const table = row.parentNode.parentNode;
            if (table.id === 'articlesTable') {
                for (let i = 1; i < table.rows.length; i++) {
                    table.rows[i].cells[0].innerHTML = i;
                }
            }
        }

        // Make functions global
        window.removeRow = removeRow;
        window.addNewRow = addNewRow;
        window.toggleSection = toggleSection;
        window.toggleVoiceInput = toggleVoiceInput;
    </script>
</body>
</html>
